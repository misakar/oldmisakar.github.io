<html>
    <head>

        <meta http-equiv="content-type" content="text/html; charset=utf-8" />
        <link href=/static/css/main.css rel="stylesheet" type="text/css">
        <title>Why Reload?</title>
    </head>
    <body>
        <h2>è®¾å®šç¼–ç çš„æƒ¯ä¾‹</h2>

<p>å½“è®¾å®špythonæ–‡ä»¶ç¼–ç æ—¶</p>

<div class="codehilite"><pre><span></span><span class="kn">import</span> <span class="nn">sys</span>

<span class="nb">reload</span><span class="p">(</span><span class="n">sys</span><span class="p">)</span>
<span class="n">sys</span><span class="o">.</span><span class="n">setdefaultencoding</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
</pre></div>

<p>ä¸‰è¡Œæå®šï¼Œå¦ˆå¦ˆå†ä¹Ÿä¸ç”¨æ‹…å¿ƒæ±‰å­—ä¹±ç äº†ï¼ğŸ˜„</p>

<h2>ç„¶è€Œï¼šé—®é¢˜æ¥äº†</h2>

<p>å‡ ä¸ªæœˆåçš„ä¸€å¤©ï¼Œæˆ‘çš„ä¸€ä¸ªæœ‹å‹é—®æˆ‘ï¼šä¸ºä»€ä¹ˆè¦ reload(sys) ? ğŸ˜”</p>

<h2>SO: Why reload(sys)</h2>

<h3>1. sys</h3>

<div class="codehilite"><pre><span></span>sys æ˜¯ä¸€ä¸ªpythonæ¨¡å—ï¼ŒåŒ…å«ç³»ç»Ÿå¯¹åº”çš„åŠŸèƒ½ï¼Œæ¯”å¦‚é€šè¿‡argvè·å–è¿è¡Œæ—¶å‘½ä»¤è¡Œå‚æ•°
</pre></div>

<p>å…·ä½“è§http://www.cnblogs.com/diege/archive/2012/10/03/2710776.html <br/></p>

<h3>2. setdefaultencoding å‡½æ•°</h3>

<p>setdefaultencoding æ˜¯sysæ¨¡å—æä¾›çš„ä¸€ä¸ªå‡½æ•°ï¼Œç”¨æ¥<strong>ä¿®æ”¹é»˜è®¤ç¼–ç </strong><br/></p>

<h3>3. python åŠ è½½æ¨¡å—çš„è¿‡ç¨‹</h3>

<div class="codehilite"><pre><span></span>è¿è¡Œè§£é‡Šå™¨ -&gt; åŠ è½½åº“æ–‡ä»¶(ex: site.py) -&gt; åŠ è½½æ¨¡å—(ex: sys)
</pre></div>

<h3>4. python reload å‡½æ•°</h3>

<div class="codehilite"><pre><span></span>reload æ˜¯pythonå†…ç½®å‡½æ•°ï¼Œç”¨äºåœ¨å½“å‰è¿è¡Œæ—¶é‡æ–°åŠ è½½æ¨¡å—ï¼Œä¸ä¼šæ”¹å˜å…ˆå‰æ–‡ä»¶ä¸­çš„æ¨¡å—çŠ¶æ€
</pre></div>

<h3>5. reload(sys)</h3>

<p>å¦‚æœæˆ‘ä»¬å°è¯•è¿è¡Œ</p>

<div class="codehilite"><pre><span></span><span class="o">&gt;&gt;</span> <span class="kn">import</span> <span class="nn">sys</span>
<span class="o">&gt;&gt;</span> <span class="n">sys</span><span class="o">.</span><span class="n">setdefaultencoding</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
<span class="ne">AttributeError</span><span class="p">:</span> <span class="s1">&#39;module&#39;</span> <span class="nb">object</span> <span class="n">has</span> <span class="n">no</span> <span class="n">attribute</span> <span class="s1">&#39;setdefaultencoding&#39;</span>
</pre></div>

<p>å‘ç°å¹¶æ²¡æœ‰<code>setdefaultencoding</code>å‡½æ•°, reloadä»¥åå°±æœ‰äº†, è¿™åˆæ˜¯æ€ä¹ˆå›äº‹å‘¢ï¼Ÿ<br/>
å½“æˆ‘ä»¬å¯¼å…¥åŠ è½½ sys æ¨¡å—æ—¶é¦–å…ˆä¼šåŠ è½½ site.py(/usr/lib/python2.7), çœ‹ä¸€ä¸‹ site.py çš„æºç ï¼š
<img alt="æºç " src="http://7xj431.com1.z0.glb.clouddn.com/å±å¹•å¿«ç…§%202015-09-08%20ä¸‹åˆ11.17.14.png" /><br/></p>

<p>åŸæ¥setdefaultencodingå‡½æ•°è¢«site.pyåˆ æ‰å•¦ï¼è‡³äºä¸ºä»€ä¹ˆè¦åˆ ï¼Œæ³¨é‡Šé‡Œå†™äº†ï¼šä½¿ç”¨æˆ·æ— æ³•åœ¨åˆå§‹åŒ–åæ”¹å˜ç¼–ç <br/>
è€Œ reload(sys) åˆ™é‡è½½äº†sysæ¨¡å—, æ²¡æœ‰äº†site.pyçš„è°ƒç”¨ï¼Œæ‰€ä»¥å¯ä»¥ä½¿ç”¨<code>setdefaultencoding</code> å‡½æ•°æ”¹å˜ç¼–ç äº†<br/></p>

<h2>ä½†æ˜¯ä»–ä»¬è¯´: <code>reload(sys) is evil</code></h2>

<p><img alt="2016-12-01 7 53 16" src="https://cloud.githubusercontent.com/assets/10671733/20793036/0771783c-b800-11e6-9c8a-6b3077d53914.png" /> <br/>
ä½œä¸ºä¸€ä¸ªä½¿ç”¨äº†<code>reload(sys), sys.setdefaultencoding</code>2å¹´çš„äºº(å› ä¸ºæˆ‘æŠŠå®ƒå†™åˆ°manaé‡Œé¢äº†...), è¿™å¥è¯ä¸€ç›´è¦ç»•åœ¨æˆ‘çš„è„‘æµ·ä¸­. ä¸ºä»€ä¹ˆevil, æˆ‘ç”¨äº†è¿™ä¹ˆé•¿æ—¶é—´, å¯æ˜¯å¹¶æ²¡æœ‰ä»€ä¹ˆé—®é¢˜å•Š? <br/>
ç»ˆäºåœ¨ä¸€ä¸ªå¤œæ™š, æˆ‘æƒ³, æˆ‘å¤§æ¦‚æ˜ç™½äº†...<br/></p>

<h3>1.å­—ç¬¦ä¸²å’Œå­—èŠ‚ä¸²</h3>

<p>Python2ä¸­æœ‰2ç±»å­—ç¬¦ä¸²ç±»å‹, ä¸€ç±»æ˜¯<code>unicode</code>ä¹Ÿå°±æ˜¯<code>å­—ç¬¦ä¸²</code>, ä¸€ç±»æ˜¯<code>str</code>ä¹Ÿå°±æ˜¯<code>å­—èŠ‚ä¸²</code>.<br/>
ç®€å•ç‚¹... å­—èŠ‚ä¸²æ˜¯å­—ç¬¦ä¸²çš„å®é™…å­˜å‚¨æ–¹å¼, æ¯”å¦‚unicodeæ˜¯ä¸€ä¸ªç¼–ç é›†, utf-8åˆ™æ˜¯unicodeçš„å…·ä½“å®ç°æ–¹å¼, ä¹Ÿå°±æ˜¯è®¡ç®—æœºä¸­äºŒè¿›åˆ¶çš„å­˜å‚¨æ–¹å¼. å…·ä½“å¯ä»¥å‚è€ƒè¿™2ç¯‡æ–‡ç« : <br/></p>

<ul>
<li><a href="http://www.ruanyifeng.com/blog/2007/10/ascii_unicode_and_utf-8.html">å­—ç¬¦ç¼–ç ç¬”è®°ï¼šASCIIï¼ŒUnicodeå’ŒUTF-8</a></li>
<li><a href="http://www.regexlab.com/zh/encoding.htm">å­—ç¬¦ï¼Œå­—èŠ‚å’Œç¼–ç </a></li>
</ul>

<p><br/></p>

<h3>2. Python2é»˜è®¤ç¼–ç æ˜¯Ascii</h3>

<p>è¿™ä¸€ç‚¹å¾ˆé‡è¦, Pythonç¬¬ä¸€ä¸ªå…¬å¼€å‘è¡Œç‰ˆæ˜¯1991å¹´, è€Œunicodeæ˜¯1991å¹´æ‰äº§ç”Ÿçš„, æ‰€ä»¥Pythoné‡‡ç”¨äº†å†å²æ‚ ä¹…çš„Asciiä½œä¸ºé»˜è®¤ç¼–ç . <br/>
Pythonå°†å­—èŠ‚ä¸²decodeä¸ºå­—ç¬¦ä¸²çš„æ—¶å€™å°±ä¼šä½¿ç”¨asciiç¼–ç , ç„¶è€Œasciiç¼–ç åªèƒ½è¡¨ç¤º256ä¸ªå­—ç¬¦, å¯¹äºæ±‰å­—ç­‰åŒå­—èŠ‚å­—ç¬¦æ— æ³•è¡¨ç¤º, æ‰€ä»¥å°±ä¼šå‡ºç°Pythonä¸­æ–‡å±Šçš„å™©æ¢¦:</p>

<div class="codehilite"><pre><span></span>UnicodeDecodeError: &#39;ascii&#39; codec can&#39;t decode byte 0xe4 in position 0:
ordinal not in range(128)
</pre></div>

<p>è€Œä½¿ç”¨</p>

<div class="codehilite"><pre><span></span><span class="kn">import</span> <span class="nn">sys</span>
<span class="nb">reload</span><span class="p">(</span><span class="n">sys</span><span class="p">)</span>
<span class="n">sys</span><span class="o">.</span><span class="n">setdefaultencoding</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
</pre></div>

<p>å°±ä¼šPythonçš„<code>é»˜è®¤ç¼–ç æ”¹ä¸ºutf-8</code></p>

<h3>é‚£è¿™æ ·æœ‰ä»€ä¹ˆä¸å¥½?</h3>

<p>è‹¥æœ‰ä¸å¥½, é‚£ä¹ˆä¸€å®šæ˜¯reloadå‰å, ç°æœ‰çš„ä»£ç è¡Œä¸ºä¼šä¸ä¸€è‡´. <br/>
æ¯”å¦‚:</p>

<div class="codehilite"><pre><span></span>s1 = u&quot;ä¸­æ–‡&quot;
s2 = &quot;ä¸­æ–‡&quot;
s1 == s2
</pre></div>

<p><code>==</code>æ¯”è¾ƒæ“ä½œä¼šæŠŠæ‰€æœ‰çš„å­—èŠ‚ä¸²å…ˆdecodeä¸ºunicodeå­—ç¬¦ä¸², ç„¶åè¿›è¡Œç¼–ç æ¯”è¾ƒ, ç”±äºPythonçš„é»˜è®¤ç¼–ç æ˜¯Ascii, æ‰€ä»¥è¿™é‡Œç”¨ascii decode "ä¸­æ–‡"çš„æ—¶å€™ä¼šå‡ºé”™:</p>

<div class="codehilite"><pre><span></span><span class="n">UnicodeWarning</span><span class="o">:</span> <span class="n">Unicode</span> <span class="n">equal</span> <span class="n">comparison</span> <span class="n">failed</span> <span class="n">to</span> <span class="n">convert</span> <span class="n">both</span> <span class="k">arguments</span> <span class="n">to</span>
<span class="n">Unicode</span> <span class="o">-</span> <span class="n">interpreting</span> <span class="n">them</span> <span class="k">as</span> <span class="n">being</span> <span class="n">unequal</span>
</pre></div>

<p>è¿™æ˜¯Pythonä¼šå› å‡ºé”™è€Œå°†ç»“æœåˆ¤ä¸ºFalse <br/>
ä½†æ˜¯, å½“ä½ reload(sys), é‡ç½®é»˜è®¤ç¼–ç ä¸ºutf-8çš„æ—¶å€™, utf-8 decodeä¸­æ–‡å°±ç»°ç»°æœ‰ä½™äº†,
è¿™æ—¶ç»“æœå°±æ˜¯True! <br/>
å­—ç¬¦ä¸²çš„ç­‰äºåˆ¤å®šè¿˜æ˜¯å¾ˆå¸¸è§çš„. reloadå‰åé€ æˆçš„è¡Œä¸ºä¸ä¸€è‡´,
çš„ç¡®ä¼šå½±å“ç»“æœ(Flase-&gt;True)!</p>

<h2>æ‰€ä»¥, ä¸ç”¨reload(sys), æˆ‘è¯¥æ€ä¹ˆåš?</h2>

<p>å¯¹äºå­—ç¬¦ä¸²ã€å­—èŠ‚ä¸², ä½¿ç”¨decodeå’Œencodeå°±å¯ä»¥å¾ˆå¥½çš„è§£å†³é—®é¢˜, æ¯”å¦‚</p>

<div class="codehilite"><pre><span></span>s1 = u&quot;ä¸­æ–‡&quot;  # unicode
s1.encode(&#39;utf-8&#39;)  # ç¼–ç ä¸ºutf-8
s2 = &quot;hello&quot;  # ascii
s2.decode(&#39;ascii&#39;)  # è§£ç ä¸ºunicode
</pre></div>

<p>æŠ“å–çš„ç½‘é¡µ, ä¹Ÿå¯ä»¥å€ŸåŠ©ç½‘é¡µmetaä¿¡æ¯, æˆ–è€…requests, bs4, chardetç­‰åˆ¤å®šç¼–ç . <br/>
ä½†æ˜¯, æˆ‘ç”¨reload(sys)çš„æœ€åˆåŸå› , æ˜¯æ¥è‡ªflask jinja2æ¨¡ç‰ˆä¸­å‡ºç°ä¸­æ–‡! <br/>
æ¯”å¦‚:</p>

<div class="codehilite"><pre><span></span>@app.route(&#39;/&#39;)
def index():
    return render_template(&#39;index.html&#39;, name=&#39;ä¹Œä¸¸åƒå²&#39;)

<span class="nt">&lt;html&gt;&lt;body&gt;</span><span class="cp">{{</span> <span class="nv">name</span> <span class="cp">}}</span><span class="nt">&lt;/body&gt;&lt;/html&gt;</span>
</pre></div>

<p>æŠ¥é”™:</p>

<div class="codehilite"><pre><span></span>File &quot;/Users/apple/holiday/blog/house/Test/app/templates/index.html&quot;, line 4, in top-level template code
    <span class="nt">&lt;h1&gt;</span><span class="cp">{{</span> <span class="nv">name</span> <span class="cp">}}</span><span class="nt">&lt;/h1&gt;</span>
UnicodeDecodeError: &#39;ascii&#39; codec can&#39;t decode byte 0xe6 in position 0: ordinal not in range(128)
</pre></div>

<p>å› ä¸º<code>{{}}</code>é‡Œé¢å®é™…ä¸Šæ˜¯Pythonè§£é‡Šå™¨åœ¨å¤„ç†{å…³äºPythonå‰ç«¯æ¨¡ç‰ˆå¯ä»¥å‚çœ‹mozillazgå¤§ç¥çš„<a href="https://mozillazg.com/2016/03/let-us-build-a-template-engine-part1.html">è®©æˆ‘ä»¬ä¸€èµ·æ¥æ„å»ºä¸€ä¸ªæ¨¡æ¿å¼•æ“</a>}, æ‰€ä»¥ä¹Ÿä¼šé‡åˆ°ä¸­æ–‡ç¼–ç ascii decode errorçš„å‘. è§£å†³åŠæ³•æ˜¯<code>u'ä¹Œä¸¸åƒå²'</code>å°±å¥½äº†...å› ä¸ºç›´æ¥unicode, ä¸ç”¨asciiè§£ç äº†... ä»¥å‰ä¸çŸ¥é“, SOPåˆ°<code>sys.setdefaultencoding('utf-8')</code>, å°±ä¸€ç›´ç”¨äº†.
<hr/>
ç¼–ç é—®é¢˜æ˜¯Pythonå±Šçš„å¤§å‘, ç°åœ¨çš„Python3åˆä¸ä¸€æ ·äº†...
æ‰“ç®—è¿‡ä¼šç¿»è¯‘ä¸€ç¯‡<a href="http://lucumr.pocoo.org/2014/1/5/unicode-in-2-and-3/">flaskä½œè€…çš„åæ§½</a>.<br/>
å°±é…±... æ€»ç®—èƒ½è‡ªåœ†å…¶è¯´äº†, æ‰€è°“çš„é€»è¾‘æ­£ç¡®... å®‰.</p>

<h2>å‚è€ƒ</h2>

<ul>
<li><a href="http://lucumr.pocoo.org/2014/1/5/unicode-in-2-and-3/">More About Unicode in Python 2 and 3</a></li>
<li><a href="http://blog.ernest.me/post/python-setdefaultencoding-unicode-bytes">ç«‹å³åœæ­¢ä½¿ç”¨ setdefaultencoding('utf-8'),ä»¥åŠä¸ºä»€ä¹ˆ</a></li>
<li><a href="http://www.regexlab.com/zh/encoding.htm">å­—ç¬¦ï¼Œå­—èŠ‚å’Œç¼–ç </a></li>
</ul>

        <div id="disqus_thread"></div>
        <script>
        /**
        * RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
        * LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables
        */
        /*
        var disqus_config = function () {
        this.page.url = PAGE_URL; // Replace PAGE_URL with your page's canonical URL variable
        this.page.identifier = PAGE_IDENTIFIER; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
        };
        */
        (function() { // DON'T EDIT BELOW THIS LINE
        var d = document, s = d.createElement('script');

        s.src = '//neo1218flask.disqus.com/embed.js';

        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
        })();
        </script>
        <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>
    </body>
</html>
