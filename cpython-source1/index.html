<html>
    <head>

        <meta http-equiv="content-type" content="text/html; charset=utf-8" />
        <link href=/static/css/main.css rel="stylesheet" type="text/css">
        <!--link href=/static/css/github.css
            rel="stylesheet" type="text/css" /-->
        <link rel="stylesheet" href="/pygments.css">
        <title>cpythonæºç é˜…è¯»ä¹‹refcount</title>
    </head>
    <body>
        <h1>cpythonæºç é˜…è¯»ä¹‹refcount</h1>

<hr/>

<blockquote>
<p>å¯’å‡å°±è¦ç»“æŸäº†, è¿™ä¸ªå¯’å‡æ´»çš„å¥½ç´¯<code>ï¼œ( ï¿£ï¸¿ï¿£)ï¸µÎ¸ï¸µÎ¸ï¸µÎ¸ï¸µÎ¸ï¸µâ˜†(ï¼å£ï¼œï¼),</code> ç»ˆäºğŸ’Šç»“æŸäº†!!! <br/>
<hr/>
è¿™2å¤©æ— èŠçœ‹äº†ä¸€ç‚¹ç‚¹cpythonçš„æºç , è§‰å¾—å¹¶æ²¡æœ‰æƒ³è±¡ä¸­çš„è‰°æ·±, ä½†æ˜¯å¾ˆå¤šä¸œè¥¿å¾ˆéš¾ç†è§£, ä¸ºä»€ä¹ˆè¦è¿™æ ·ã€ä¸ºä»€ä¹ˆè¦é‚£æ ·. æœç„¶å¤§ç¥çš„æ€æƒ³ä¸æ˜¯æˆ‘ç­‰å¸¸äººèƒ½å¤Ÿç†è§£çš„<code>( &gt;ï¹&lt;ã€‚)~</code>. ä¸è¿‡æ‰åˆšå¼€å§‹çœ‹, æ·±å…¥äº†ä»¥åæˆ–è®¸å°±æ˜ç™½äº†è¿™äº›ä»£ç èƒŒåçš„ç”¨æ„! <br/>
æ­£å¥½ä¹‹å‰æ€»ç»“äº†ä¸€ä¸‹<a href="https://neo1218.github.io/pymemory/">Pythonçš„å†…å­˜ç®¡ç†</a>, ç„¶è€Œä»…ä»…åœç•™åœ¨ä½¿ç”¨å±‚é¢ä¸Šçš„æ€»ç»“ä¸æ˜¯å¾ˆè¸å®, æ¯”å¦‚ä¹‹å‰è¯´äº†: cpythonä¼šåœ¨æŸæ—¶åˆ»éå†æ‰€æœ‰çš„å¯¹è±¡å¹¶å‡å°‘è¢«å¼•ç”¨å¯¹è±¡çš„å¼•ç”¨è®¡æ•°æ¥æ¶ˆé™¤å¼•ç”¨ç¯, å¯æ˜¯ä»€ä¹ˆæ—¶å€™éå†? å¦‚ä½•éå†æ‰€æœ‰(ä¸åŒç±»å‹çš„)å¯¹è±¡? å¦‚ä½•å‡å°‘å¼•ç”¨è®¡æ•°? ...... <br/>
è¿˜æ˜¯å»æºç é‡Œä¸€æ¢ç©¶ç«Ÿå§!
<hr/></p>
</blockquote>

<h2>ä»€ä¹ˆæ˜¯reference count ?</h2>

<p>reference countæ˜¯Pythonå¯¹è±¡çš„å±æ€§, ç”¨äºè¡¨ç¤ºè¯¥å¯¹è±¡è¢«å¼•ç”¨çš„æ¬¡æ•°. reference countæ˜¯cpythonè¿›è¡Œgcçš„æœ€é‡è¦æŒ‡æ ‡:<code>å½“æŸä¸ªå¯¹è±¡çš„reference countä¸º0æ—¶, è¡¨ç¤ºæ²¡æœ‰ä»£ç ä½¿ç”¨è¿™ä¸ªå¯¹è±¡, é‚£ä¹ˆè¯¥å¯¹è±¡å ç”¨çš„å†…å­˜å°±ä¼šè¢«é‡Šæ”¾.</code> <br/>
æ¯ä¸ªPythonå¯¹è±¡éƒ½<strong>ç»§æ‰¿</strong>äº†<strong>PyObject</strong></p>

<div class="codehilite"><pre><span></span><span class="k">typedef</span> <span class="k">struct</span> <span class="n">_object</span> <span class="p">{</span>
    <span class="n">_PyObject_HEAD_EXTRA</span>
    <span class="n">Py_ssize_t</span> <span class="n">ob_refcnt</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">_typeobject</span> <span class="o">*</span><span class="n">ob_type</span><span class="p">;</span>
<span class="p">}</span> <span class="n">PyObject</span><span class="p">;</span>

<span class="c1">// _PyObject_HEAD_EXTRA</span>
<span class="cp">#define _PyObject_HEAD_EXTRA            \</span>
<span class="cp">    struct _object *_ob_next;           \</span>
<span class="cp">    struct _object *_ob_prev;</span>
</pre></div>

<p><strong>_PyObject_HEAD_EXTRA</strong>ä¸å°±æ˜¯æ“ä½œç³»ç»Ÿé‡Œåšçº¿ç¨‹ç®¡ç†çš„æ—¶å€™ç”¨åˆ°çš„é€šç”¨åŒå‘é“¾è¡¨æŒ‡é’ˆå—! çœ‹æ¥cpythonä¹Ÿé€šè¿‡å®šä¹‰é€šç”¨çš„é“¾è¡¨èŠ‚ç‚¹æŒ‡é’ˆé“¾æ¥æ‰€æœ‰ä¸åŒç±»å‹çš„å¯¹è±¡ä»¥ä¾¿éå†å‘¢!
<strong>ob_refcnt</strong>å°±æ˜¯è¯¥å¯¹è±¡çš„å¼•ç”¨è®¡æ•°,ç±»å‹æ˜¯Py_ssize_t(<code>typedef Py_ssize_t long;</code>), <strong>ob_type</strong>æ˜¯æŒ‡å‘<strong>PyTypeObject</strong>çš„ç±»å‹æŒ‡é’ˆ. <br/>
é‚£ä¹ˆç»§æ‰¿å…³ç³»æ˜¯å¦‚ä½•ä½“ç°çš„å‘¢? ä»¥<strong>PyListObject</strong>ä¸ºä¾‹:</p>

<div class="codehilite"><pre><span></span><span class="k">typedef</span> <span class="k">struct</span> <span class="p">{</span>
    <span class="n">PyObject_VAR_HEAD</span>
    <span class="cm">/* Vector of pointers to list elements.  list[0] is ob_item[0], etc. */</span>
    <span class="n">PyObject</span> <span class="o">**</span><span class="n">ob_item</span><span class="p">;</span>
    <span class="n">Py_ssize_t</span> <span class="n">allocated</span><span class="p">;</span>
<span class="p">}</span> <span class="n">PyListObject</span><span class="p">;</span>

<span class="c1">// PyObject_VAR_HEAD</span>
<span class="cp">#define PyObject_VAR_HEAD      PyVarObject ob_base;</span>
</pre></div>

<p>è¿™é‡Œå…ˆè¿‡æ¸¡ä¸€ä¸‹, å› ä¸ºlistæ˜¯å®¹å™¨, é™¤äº†å¼•ç”¨è®¡æ•°å’Œç±»å‹å¤–è¿˜éœ€è¦å®¹å™¨å¤§å°ç­‰å±æ€§,
æ‰€ä»¥cpythonå®šä¹‰äº†ä¸€ä¸ªPyVarObjectç»“æ„ä½“ç”¨äºå­˜å‚¨è¿™äº›å˜é‡:</p>

<div class="codehilite"><pre><span></span><span class="k">typedef</span> <span class="k">struct</span> <span class="p">{</span>
    <span class="n">PyObject</span> <span class="n">ob_base</span><span class="p">;</span>
    <span class="n">Py_ssize_t</span> <span class="n">ob_size</span><span class="p">;</span> <span class="cm">/* Number of items in variable part */</span>
<span class="p">}</span> <span class="n">PyVarObject</span><span class="p">;</span>
</pre></div>

<p>PyVarObjectçš„<strong>å¼€å¤´</strong>å®šä¹‰äº†<code>PyObject ob_base</code>å®ç°äº†ç»§æ‰¿.  ä¹Ÿå°±æ˜¯è¯´:<strong>PyListObjectç»§æ‰¿PyVarObject, PyVarObjectç»§æ‰¿PyObject</strong>. <br/>
Cä¸æ˜¯é¢å‘è¿‡ç¨‹çš„è¯­è¨€å—?å¦‚ä½•å®ç°ç»§æ‰¿å‘¢? ä¸€å¼€å§‹æˆ‘ä¹Ÿå¾ˆç–‘æƒ‘, ä¸è¿‡åœ¨çœ‹äº†<a href="https://neo1218.github.io/libuv2/">libuvçš„æºç åå¼„æ˜ç™½äº†</a>, è¿™é‡Œçš„ç»§æ‰¿å…¶å®æ˜¯<strong>memory cast trick</strong>, å› ä¸ºç»“æ„ä½“ä¸­å†…å­˜åˆ†å¸ƒæ˜¯é¡ºåºçš„, æ‰€ä»¥PyListObjectå¯ä»¥è¢«castæˆPyVarObject(ä¸¢æ‰å¤šä½™çš„å†…å­˜); åŒç†, PyVarObjectå¯ä»¥è¢«castæˆPyObject. ä¸è¿‡ç›¸æ¯”å¦‚OOPä¸­çš„ç»§æ‰¿, è¿™é‡Œå¯æ²¡æœ‰æƒé™æ£€æŸ¥o(<em>ï¿£â–½ï¿£</em>)ã‚ ! <br/>
æ‰€ä»¥, æ¯ä¸€ä¸ªPythonå¯¹è±¡é€šè¿‡ç»§æ‰¿PyObjectè€Œæ‹¥æœ‰å¼•ç”¨è®¡æ•°ob_refcnt.</p>

<h2>Py_INCREF()å’ŒPy_DECREF()</h2>

<p>Pythonä½¿ç”¨å®Py_INCREF()å’ŒPy_DECREF()å¢åŠ å’Œå‡å°‘å¼•ç”¨è®¡æ•°. è¿™2ä¸ªå®æ¯”è¾ƒå¤æ‚, æ”¹å˜å¼•ç”¨è®¡æ•°å¯ä¸ä»…ä»…æ˜¯åšåšåŠ å‡, è¿˜éœ€è¦è¿›è¡Œæ£€æŸ¥, Py_DECREF()åœ¨å¼•ç”¨è®¡æ•°ä¸º0æ—¶è¿˜éœ€è¦è°ƒç”¨destructoré‡Šæ”¾å¯¹è±¡çš„å†…å­˜:</p>

<div class="codehilite"><pre><span></span><span class="k">typedef</span> <span class="nf">void</span> <span class="p">(</span><span class="o">*</span><span class="n">destructor</span><span class="p">)(</span><span class="n">PyObject</span> <span class="o">*</span><span class="p">)</span>
<span class="k">typedef</span> <span class="k">struct</span> <span class="n">_typeobject</span> <span class="p">{</span>
    <span class="p">...</span>
    <span class="n">destructor</span> <span class="n">tp_dealloc</span><span class="p">;</span>
    <span class="p">...</span>
<span class="p">}</span> <span class="n">PyTypeObject</span><span class="p">;</span>
<span class="c1">// æ¯ä¸ªPyObjectéƒ½åŒ…å«æŒ‡å‘PyTypeObjectçš„æŒ‡é’ˆ, å¯ä»¥æ‹¿åˆ°destructor</span>
</pre></div>

<p>å…ˆçœ‹çœ‹Py_INCREF()å®</p>

<div class="codehilite"><pre><span></span><span class="cp">#define Py_INCREF(op) (                         \</span>
<span class="cp">    _Py_INC_REFTOTAL  _Py_REF_DEBUG_COMMA       \</span>
<span class="cp">    ((PyObject *)(op))-&gt;ob_refcnt++)</span>
<span class="c1">// å±•å¼€åçš„ä»£ç å¦‚ä¸‹</span>
<span class="cp">#define Py_INCREF(op) (                         \</span>
<span class="cp">    _Py_RefTotal++ ,                            \</span>
<span class="cp">    ((PyObject *)(op))-&gt;ob_refcnt++)</span>
</pre></div>

<p>Py_INCREF()æ¯”è¾ƒç®€å•, å°†å¯¹è±¡çš„å¼•ç”¨è®¡æ•°å¢åŠ å°±è¡Œäº†, è¿™é‡Œç°å°†å¯¹è±¡è½¬æ¢æˆ"åŸºç±»"PyObjectä»è€Œæ‹¿åˆ°ob_refcnt. <br/>
å†çœ‹Py_DECREF()å®:</p>

<div class="codehilite"><pre><span></span><span class="cp">#define Py_DECREF(op)                                   \</span>
<span class="cp">    do {                                                \</span>
<span class="cp">        PyObject *_py_decref_tmp = (PyObject *)(op);    \</span>
<span class="cp">        if (_Py_DEC_REFTOTAL  _Py_REF_DEBUG_COMMA       \</span>
<span class="cp">        --(_py_decref_tmp)-&gt;ob_refcnt != 0)             \</span>
<span class="cp">            _Py_CHECK_REFCNT(_py_decref_tmp)            \</span>
<span class="cp">        else                                            \</span>
<span class="cp">            _Py_Dealloc(_py_decref_tmp);                \</span>
<span class="cp">    } while (0)</span>
<span class="c1">// å±•å¼€åçš„ä»£ç å¦‚ä¸‹(æ–¹ä¾¿è¯»æˆ‘æŠŠå®æ¢è¡Œè¿æ¥ç¬¦å»äº†)</span>
<span class="k">do</span> <span class="p">{</span>
      <span class="n">PyObject</span> <span class="o">*</span><span class="n">_py_decref_tmp</span> <span class="o">=</span> <span class="p">(</span><span class="n">PyObject</span> <span class="o">*</span><span class="p">)(</span><span class="n">op</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">_Py_RefTotal</span><span class="o">--</span><span class="p">,</span> <span class="o">--</span><span class="p">(</span><span class="n">_py_decref_tmp</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">ob_refcnt</span> <span class="o">!=</span><span class="mi">0</span> <span class="p">)</span> <span class="p">{</span>
          <span class="p">{</span><span class="k">if</span> <span class="p">(((</span><span class="n">PyObject</span><span class="o">*</span><span class="p">)</span><span class="n">_py_decref_tmp</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">ob_refcnt</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
               <span class="cm">/* debugæŠ›å¼‚å¸¸ */</span>
               <span class="n">_Py_NegativeRefcount</span><span class="p">(</span><span class="n">__FILE__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span>
               <span class="p">(</span><span class="n">PyObject</span> <span class="o">*</span><span class="p">)(</span><span class="n">_py_decref_tmp</span><span class="p">));</span>
          <span class="p">}}</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
          <span class="n">dec_count</span><span class="p">(</span><span class="n">Py_TYPE</span><span class="p">(</span><span class="n">_py_decref_tmp</span><span class="p">));</span>
          <span class="p">(</span><span class="o">*</span><span class="n">Py_TYPE</span><span class="p">(</span><span class="n">_py_decref_tmp</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">tp_dealloc</span><span class="p">)((</span><span class="n">PyObject</span> <span class="o">*</span><span class="p">)(</span><span class="n">_py_decref_tmp</span><span class="p">));</span>
      <span class="p">}</span>
<span class="p">}</span> <span class="k">while</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>    
<span class="c1">// Py_TYPEå®</span>
<span class="cp">#define Py_TYPE(ob)             (((PyObject*)(ob))-&gt;ob_type)</span>
<span class="c1">// dec_countå‡½æ•°</span>
<span class="kt">void</span> <span class="n">dec_count</span><span class="p">(</span><span class="n">PyTypeObject</span> <span class="o">*</span><span class="n">tp</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">tp</span><span class="o">-&gt;</span><span class="n">tp_frees</span><span class="o">++</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">unlist_types_without_objects</span> <span class="o">&amp;&amp;</span>
        <span class="n">tp</span><span class="o">-&gt;</span><span class="n">tp_allocs</span> <span class="o">==</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">tp_frees</span><span class="p">)</span> <span class="p">{</span>
        <span class="cm">/* unlink the type from type_list */</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">tp_prev</span><span class="p">)</span>
            <span class="n">tp</span><span class="o">-&gt;</span><span class="n">tp_prev</span><span class="o">-&gt;</span><span class="n">tp_next</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">tp_next</span><span class="p">;</span>
        <span class="k">else</span>
            <span class="n">type_list</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">tp_next</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">tp_next</span><span class="p">)</span>
            <span class="n">tp</span><span class="o">-&gt;</span><span class="n">tp_next</span><span class="o">-&gt;</span><span class="n">tp_prev</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">tp_prev</span><span class="p">;</span>
        <span class="n">tp</span><span class="o">-&gt;</span><span class="n">tp_next</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">tp_prev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
        <span class="n">Py_DECREF</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>

<p>è¿™ä¸ªå®å‡å°‘å¯¹è±¡çš„å¼•ç”¨è®¡æ•°, å¤–å›´åŠ ä¸Šæ£€æŸ¥, å¦‚æœå¼•ç”¨è®¡æ•°å°äºé›¶, åˆ™debugæŠ¥é”™. <br/>
å¦‚æœå¼•ç”¨è®¡æ•°ä¸º0, dec_countå‡½æ•°å°†è¯¥å¯¹è±¡ä»ç±»å‹é“¾(type_list)ä¸­å–å‡º, ç»§ç»­è°ƒç”¨Py_DECREFå®, å°†å¯¹è±¡obè½¬æ¢ä¸ºPyObjectç±»å‹, æ‹¿åˆ°æŒ‡å‘PyTypeObjectçš„æŒ‡é’ˆ, è®¿é—®obçš„destructor: tp_deallocé‡Šæ”¾å¯¹è±¡å†…å­˜. <br/></p>

<h2>ä½¿ç”¨Py_INCREF()å’ŒPy_DECREF()çš„å‡ ç§æƒ…å†µ</h2>

<p>ç†è®ºä¸Š, ä½¿ç”¨ä¸€æ¬¡Py_INCREF()å°±è¦ç›¸åº”çš„è°ƒç”¨ä¸€æ¬¡Py_DECREF(), ä¸è¿‡ç”±äºå¼•ç”¨çš„ä¼ é€’æ€§, å®é™…æƒ…å†µ(æ¯”å¦‚å†™cpythonæ‰©å±•)å¾€å¾€æ¯”è¾ƒå¤æ‚, å¯¹äºè°è¯¥è°ƒç”¨Py_DECREF()ã€Py_DECREF(), æœ‰ä»¥ä¸‹å‡ ç§æƒ…å†µ: </p>

<h3>1. è¢«è°ƒå‡½æ•°è¿”å›PyObjectå¼•ç”¨ç»™ä¸»è°ƒå‡½æ•°</h3>

<p>æ¯”å¦‚:</p>

<div class="codehilite"><pre><span></span><span class="n">PyObject</span><span class="o">*</span> <span class="nf">Py_Something</span><span class="p">(</span><span class="n">arguments</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">MyCode</span><span class="p">(</span><span class="n">arguments</span><span class="p">)</span> <span class="p">{</span>
     <span class="n">PyObject</span><span class="o">*</span> <span class="n">pyo</span><span class="p">;</span>
     <span class="p">...</span>
     <span class="n">pyo</span> <span class="o">=</span> <span class="n">Py_Something</span><span class="p">(</span><span class="n">args</span><span class="p">);</span>
     <span class="n">Py_DECREF</span><span class="p">(</span><span class="n">pyo</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>

<p>Py_Somethingå‡½æ•°æœ‰ä¸‹é¢è¿™äº›:</p>

<ul>
<li>PyTuple_GetItem(),</li>
<li>PyList_GetItem(),</li>
<li>PyList_GET_ITEM(),</li>
<li>PyList_SET_ITEM(),</li>
<li>PyDict_GetItem(),</li>
<li>PyDict_GetItemString(),</li>
<li>PyErr_Occurred(),</li>
<li>PyFile_Name(),</li>
<li>PyImport_GetModuleDict(),</li>
<li>PyModule_GetDict(),</li>
<li>PyImport_AddModule(),</li>
<li>PyObject_Init(),</li>
<li>Py_InitModule(),</li>
<li>Py_InitModule3(),</li>
<li>Py_InitModule4(), and</li>
<li>PySequence_Fast_GET_ITEM()</li>
</ul>

<p>è¿™äº›å‡½æ•°éƒ½è°ƒç”¨äº†Py_INCREF, ä½¿ç”¨è¿™äº›å‡½æ•°çš„å¤–å›´å‡½æ•°åªéœ€è¦è°ƒç”¨Py_DECREF. <br/></p>

<h3>2. ä¸»è°ƒå‡½æ•°ä¼ é€’PyObjectå¼•ç”¨ç»™è¢«è°ƒå‡½æ•°</h3>

<h3>3. ä¿è¯æŸä¸ªPyObjectå­˜åœ¨, ä¸è¢«gc</h3>

<p>è¿™ä¸ªæƒ…å†µæ¯”è¾ƒå¤æ‚, è¿˜æ˜¯å•ç‹¬å¼€ä¸€ç¯‡æ€»ç»“å§.</p>

<h2>cpythonæ˜¯å¦‚ä½•æ¶ˆé™¤å¼•ç”¨ç¯çš„?</h2>

<p>o(ï¿£â”°ï¿£*)ã‚â†’ <a href="https://github.com/python/cpython/blob/master/Modules/gcmodule.c">æˆ‘è¿˜æ²¡çœ‹</a></p>
        <div id="disqus_thread"></div>
        <script>
        /**
        * RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
        * LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables
        */
        /*
        var disqus_config = function () {
        this.page.url = PAGE_URL; // Replace PAGE_URL with your page's canonical URL variable
        this.page.identifier = PAGE_IDENTIFIER; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
        };
        */
        (function() { // DON'T EDIT BELOW THIS LINE
        var d = document, s = d.createElement('script');

        s.src = '//neo1218flask.disqus.com/embed.js';

        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
        })();
        </script>
        <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>
    </body>
</html>
