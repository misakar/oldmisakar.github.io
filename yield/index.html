<html>
    <head>

        <meta http-equiv="content-type" content="text/html; charset=utf-8" />
        <link href=/static/css/main.css rel="stylesheet" type="text/css">
        <title>å…³äºPython yieldçš„ä¸€äº›å¸¸è¯†</title>
    </head>
    <body>
        <p><img alt="" src="http://7xj431.com1.z0.glb.clouddn.com/%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202016-11-10%20%E4%B8%8B%E5%8D%886.41.12.png" /></p>
<h1>å…³äºPython yieldçš„ä¸€äº›å¸¸è¯†</h1>
<h2>1. yieldå…³é”®å­—</h2>
<p><a href="https://www.python.org/dev/peps/pep-0255/">PEP 255 -- Simple Generators</a>ä¸­å¼•å…¥äº†yieldå…³é”®å­—:</p>
<div class="codehilite"><pre><span></span>This PEP introduces the concept of generators to Python, as well
as a new statement used in conjunction with them, the &quot;yield&quot;
statement.
</pre></div>


<p>yieldå…³é”®å­—ç”¨æ¥å®ç°ç”Ÿæˆå™¨. <br/>
ä»€ä¹ˆæ˜¯ç”Ÿæˆå™¨å‘¢? ç”Ÿæˆå™¨æ˜¯ä¸€ä¸ª<strong>å¯è¿­ä»£</strong>çš„å¯¹è±¡(å®ç°äº†<code>__iter__</code>æ–¹æ³•çš„å¯¹è±¡).
ä½†ç›¸æ¯”äºåˆ—è¡¨ã€å…ƒç»„ç­‰å¯è¿­ä»£å¯¹è±¡, ç”Ÿæˆå™¨çš„è°ƒç”¨ä¸ä¼šç«‹å³æ‰§è¡Œå¾—åˆ°ç»“æœ, è€Œæ˜¯è¿”å›ä¸€ä¸ªgeneratorå¯¹è±¡, æ¯æ¬¡æ‰‹åŠ¨è°ƒç”¨nextæ‰§è¡Œç”Ÿæˆå™¨å¯¹è±¡æ‰èƒ½å¾—åˆ°ç»“æœ, æ¯”å¦‚:</p>
<div class="codehilite"><pre><span></span>In [23]: def generator():
...:     print(&#39;--- start ---&#39;)
...:     yield 1
...:     print(&#39;--- end ---&#39;)
...:     yield 2
...:
In [24]: gen = generator()

In [25]: gen
Out[25]: &lt;generator object generator at 0x110361bf8&gt;

In [26]: next(gen)
--- start ---
Out[26]: 1

In [27]: next(gen)
--- end ---
Out[27]: 2

In [28]: next(gen)
---------------------------------------------------------------------------
StopIteration                             Traceback (most recent call last)
&lt;ipython-input-28-8a6233884a6c&gt; in &lt;module&gt;()
----&gt; 1 next(gen)

StopIteration:
</pre></div>


<p>å½“ç”Ÿæˆå™¨è¿­ä»£ç»“æŸæ—¶, ä¼šraiseä¸€ä¸ªStopIterationé”™è¯¯. <br/>
å¯æ˜¯, è¿™ç©¶ç«Ÿæœ‰ä»€ä¹ˆç”¨å‘¢? æŠŠå¥½å¥½çš„ä¸€ä¸ªå¯è¿­ä»£å¯¹è±¡çš„æ‰§è¡Œæµæ‹†çš„å››åˆ†äº”è£‚? <br/></p>
<p>éœ€è¦æ³¨æ„åˆ°çš„æ˜¯: <strong>ç”Ÿæˆå™¨æ˜¯ä¸€ä¸ªå‡½æ•°</strong>, å‡½æ•°å°±æ˜¯ä¸€æ®µæ‰§è¡Œæµ,
ä¹Ÿå°±æ˜¯è¯´é€šè¿‡yield, æˆ‘ä»¬å¯ä»¥æŠŠä¸€ä¸ªå‡½æ•°æ‰§è¡Œæµåˆ’åˆ†æˆæ›´ç»†çš„æ‰§è¡Œæµ,
è€Œä¸”å¯ä»¥é€šè¿‡nextæ‰‹åŠ¨è°ƒåº¦. å°±ç®—ä¸­é—´å‘ç”Ÿåˆ‡æ¢ä¹Ÿæ²¡å…³ç³»,
ç”Ÿæˆå™¨å¸®æˆ‘ä»¬ä¿å­˜äº†æ‰§è¡Œæ—¶ç¯å¢ƒä¿¡æ¯!(æ”¾åœ¨å†…å­˜ä¸­). 
<hr/>
è¿™å°±å¼€å§‹å˜å¾—æœ‰æ„æ€äº†, å¦‚æœæ²¡æœ‰æ„Ÿè§‰åˆ°, å¯ä»¥æƒ³æƒ³: è¿›ç¨‹ã€çº¿ç¨‹ã€ä¸­æ–­:) <br/>
æ­¤å¤–, è¿˜å¯ä»¥ç”¨å…ƒç»„ç”Ÿæˆå¼åˆ›å»ºç”Ÿæˆå™¨:</p>
<div class="codehilite"><pre><span></span>In [29]: lt = [1, 2, 3, 4]

In [30]: gen = (i for i in lt)

In [31]: gen
Out[31]: &lt;generator object &lt;genexpr&gt; at 0x110213938&gt;

In [32]: next(gen)
Out[32]: 1
</pre></div>


<p>è¿™é‡Œçš„ç”Ÿæˆå™¨genæ›´åƒæ˜¯åˆ—è¡¨è¿™æ ·çš„å®¹å™¨, ä¸è¿‡ç›¸æ¯”äºåˆ—è¡¨, ç”Ÿæˆå™¨å ç”¨çš„å†…å­˜æ›´å°‘,
å› ä¸ºä¸ç”¨æŠŠå…¨éƒ¨ç»“æœå­˜æ”¾åœ¨å†…å­˜ä¸­:) <br/>
ç”Ÿæˆå™¨è¿˜æœ‰ä¸€ä¸ªæœ‰æ„æ€çš„ç‰¹æ€§<strong>sendæ–¹æ³•</strong>:</p>
<div class="codehilite"><pre><span></span>In [34]: def double_result():
    ...:     x = yield
    ...:     yield x * 2
    ...:

In [35]: gen = double_result()

In [36]: gen
Out[36]: &lt;generator object double_result at 0x1103922b0&gt;

In [37]: gen.send(None) # next(gen)

In [38]: gen.send(4)
Out[38]: 8
</pre></div>


<p>è¿™é‡Œä¸»çº¿ç¨‹è°ƒç”¨sendæ–¹æ³•, å°†æ‰§è¡Œæµäº¤ç»™gen(double_resultå‡½æ•°), ç›¸å½“äºæ‰§è¡Œnext(gen), å¹¶ä¸”ä¼ é€’äº†ä¸€ä¸ªå€¼ç»™gen[x = yield]. sendæ–¹æ³•è¿”å›genæ¯æ¬¡æ‰§è¡Œçš„ç»“æœ. <br/>
ä¸»çº¿ç¨‹å’Œç”Ÿæˆå™¨æ‰§è¡Œæµé—´çš„äº¤äº’, å°±æ˜¯è¿™ä¹ˆç¾å¦™ã€ç›´æ¥!;</p>
<h2>2. yieldå…³é”®å­—çš„ç”¨å¤„</h2>
<p>ä¸Šé¢è¯´çš„æ›´å¤šå…³æ³¨ç”Ÿæˆå™¨æœ¬èº«çš„ç‰¹æ€§, è¿™ä¸€éƒ¨åˆ†ä¼šä»‹ç»ç”Ÿæˆå™¨(yield)çš„å®é™…ä½¿ç”¨.</p>
<h3>ç®¡é“?</h3>
<p>è¿™ä¸ªéƒ¨åˆ†ä¸»è¦å‚è€ƒ<a href="http://www.dabeaz.com/generators/Generators.pdf">Dabeazçš„Generators pdf</a>. <br/>
å½“æˆ‘çœ‹åˆ°Dabeazçš„Generators pdf, çœ‹åˆ°é‡Œé¢æ‰€ä¸¾çš„ä¾‹å­, è™½ç„¶éƒ½æ˜¯ç”Ÿæˆå™¨å¸¸è§„æ™®é€šçš„ç”¨æ³•, ä½†æ˜¯å°†ç”Ÿæˆå™¨ä½œä¸ºä¸­é—´å¯¹è±¡, å¿½ç•¥ç»†èŠ‚, æŠŠç”Ÿæˆå™¨å½“ä½œä¸€ä¸ªå†…å­˜å ç”¨å°‘çš„æ•´ä½“ä½œä¸ºç®¡é“pipelineè¿æ¥2ä¸ªå¤„ç†ç¨‹åº, è¿™ç§unix styleè¿˜æ˜¯è®©æˆ‘ååˆ†æƒŠè®¶, ç”¨Dabeazçš„è¯æ¥è¯´å°±æ˜¯<strong>Think Big</strong> <br/>
æ¯”å¦‚, ç°åœ¨æœ‰ä¸€ä¸ªGBçº§åˆ«çš„nginx logæ—¥å¿—, æˆ‘ä»¬å¸Œæœ›æ‹¿åˆ°å…¨éƒ¨ip(ä¸é‡å¤)åšè¿›ä¸€æ­¥å¤„ç†(ç»Ÿè®¡ã€åˆ†æ...). <br/>
é¦–å…ˆ:</p>
<ul>
<li>æ‰“å¼€æ—¥å¿—æ–‡ä»¶, å°†æ—¥å¿—æ”¾åˆ°ä¸€ä¸ª<strong>ç”Ÿæˆå™¨</strong>ä¸­</li>
<li>è¯»å–<strong>ç”Ÿæˆå™¨</strong>ä¸­æ—¥å¿—æ‹¿åˆ°ipæ”¾åˆ°ä¸€ä¸ª<strong>ç”Ÿæˆå™¨</strong>ä¸­</li>
<li>åˆ©ç”¨é›†åˆå¯¹ip<strong>ç”Ÿæˆå™¨</strong>è¿›è¡Œå»é‡, å¾—åˆ°æ‰€æœ‰ipé›†åˆ</li>
</ul>
<p><code>nginx_log = open('big-nginx-access.log')
ip_columns = (line.split()[0] for line in nginx_log)
ip_set = set(ip_columns)</code></p>
<p>æ‰§è¡Œçš„æµç¨‹å›¾:</p>
<p><img alt="" src="http://7xj431.com1.z0.glb.clouddn.com/%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202016-11-10%20%E4%B8%8B%E5%8D%888.16.15.png" /> <br/></p>
<h3>ä¸Šä¸‹æ–‡ç®¡ç†å™¨</h3>
<p>åœ¨ç¼–ç¨‹ä¸­æˆ‘ä»¬ç»å¸¸ä¼šé‡åˆ°è¿™äº›æƒ…å†µ:</p>
<div class="codehilite"><pre><span></span>f = open()
......
f.close()

lock.acquire()
......
lock.release()

db.start_transaction()
......
db.commit()
</pre></div>


<p>ä¸€èˆ¬æˆ‘ä»¬ä¼šä½¿ç”¨ä¸Šä¸‹æ–‡ç®¡ç†å™¨å¤„ç†è¿™äº›æƒ…å†µ, ä¸Šä¸‹æ–‡ç®¡ç†å™¨ä¼šå¸®æˆ‘ä»¬è‡ªåŠ¨å…³é—­äº‹åŠ¡,
æˆ‘ä»¬åªéœ€è¦ä¸“æ³¨æ ¸å¿ƒå¤„ç†ä»£ç å°±è¡Œäº†. <br/>
æ‰€è°“ä¸Šä¸‹æ–‡ç®¡ç†å™¨å°±æ˜¯å®ç°äº†<code>__enter__</code>å’Œ<code>__exit__</code>æ–¹æ³•çš„ç±»,
æ¯”å¦‚åœ¨ä¸€ä¸ªä¸Šä¸‹æ–‡ä¸­åˆ›å»ºå¹¶ä½¿ç”¨ä¸€ä¸ªä¸´æ—¶æ–‡ä»¶</p>
<div class="codehilite"><pre><span></span><span class="k">class</span> <span class="n">tempdir</span>(<span class="n">object</span>):
    <span class="n">def</span> <span class="n">__enter__</span>(<span class="k">self</span>):
        <span class="k">self</span>.<span class="n">dirname</span> = <span class="n">tempfile</span>.<span class="n">mkdtemp</span>()
        <span class="k">return</span> <span class="k">self</span>.<span class="n">dirname</span>

    <span class="n">def</span> <span class="n">__exit__</span>(<span class="k">self</span>):
        <span class="n">shutil</span>.<span class="n">rmtree</span>(<span class="k">self</span>.<span class="n">dirname</span>)
</pre></div>


<p>è¿™æ ·å°±å¯ä»¥ä½¿ç”¨</p>
<div class="codehilite"><pre><span></span>with tempdir() as value:
    # æ ¸å¿ƒä»£ç !
</pre></div>


<p>Pythonè¿˜æä¾›äº†ä¸€ä¸ª<strong>@contextmanagerè£…é¥°å™¨</strong>æ–¹ä¾¿æˆ‘ä»¬ç¼–å†™ä¸Šä¸‹æ–‡ç®¡ç†å™¨</p>
<div class="codehilite"><pre><span></span>@contextmanager
def tempdir():
    dirname = tempdir.mkdtemp()
    try:
        yield dirname
    finally:
        shutil.rmtree(dirname)
</pre></div>


<p>å…¶å®<code>@contextmanager</code>è£…é¥°å™¨åªæ˜¯å¯¹ä¸Šä¸‹æ–‡ç®¡ç†å™¨ç±»ä»£ç çš„é‡æ„, é‡æ„çš„å…³é”®å°±æ˜¯</p>
<div class="codehilite"><pre><span></span>yield dirname
</pre></div>


<p>è¿™é‡Œçš„yield! <br/>
ç¬¬ä¸€çœ¼çœ‹åˆ°è¿™ä¸ªyieldçš„æ—¶å€™, æˆ‘æ˜¯æ‡µbçš„, è¿™ä¸ªyieldåˆ°åº•æ˜¯åšä»€ä¹ˆçš„?
è¿™å°±éœ€è¦çœ‹çœ‹contextmanagerè£…é¥°å™¨çš„å®ç°äº† <br/>
contextmanagerè£…é¥°å™¨å¤§è‡´å®ç°éƒ¨åˆ†å¦‚ä¸‹: <br/>
è£…é¥°å™¨éƒ¨åˆ†:</p>
<div class="codehilite"><pre><span></span>def contextmanager(func):
    def run(*args, **kwargs):
        return GeneratorCM(func(*args, **kwargs))
    return func
</pre></div>


<p>å†æ¥çœ‹çœ‹GeneratorCMç±»çš„å¤§è‡´å®ç°:</p>
<div class="codehilite"><pre><span></span><span class="k">class</span> <span class="n">GeneratorCM</span>(<span class="n">object</span>):
    <span class="n">def</span> <span class="n">__init__</span>(<span class="k">self</span>, <span class="n">gen</span>):
        <span class="k">self</span>.<span class="n">gen</span> = <span class="n">gen</span>

    <span class="n">def</span> <span class="n">__enter__</span>(<span class="k">self</span>):
        <span class="k">return</span> <span class="k">next</span>(<span class="n">gen</span>)  <span class="c c-Singleline"># æ‰§è¡Œç”Ÿæˆå™¨, æ‹¿åˆ°dirname (value)</span>

    <span class="n">def</span> <span class="n">__exit__</span>(<span class="k">self</span>, <span class="n">exc_type</span>):
        <span class="n">try:</span>
            <span class="k">if</span> <span class="n">exc_type</span> <span class="k">is</span> <span class="n">None:</span>
                <span class="k">next</span>(<span class="k">self</span>.<span class="n">gen</span>)
            <span class="n">else:</span>
                <span class="k">self</span>.<span class="n">gen</span>.<span class="n">throw</span>(<span class="n">exc_type</span>)
        <span class="n">except</span> <span class="n">StopIteration:</span> <span class="c c-Singleline"># åˆ©ç”¨StopIterationé€€å‡ºä¸Šä¸‹æ–‡</span>
            <span class="k">return</span> <span class="nb">True</span>
</pre></div>


<p>åŸæ¥yieldå°†è¢«ä¿®é¥°çš„å‡½æ•°å˜æˆç”Ÿæˆå™¨,
è¿˜è®°å¾—ä¹‹å‰è¯´è¿‡çš„å¯ä»¥é€šè¿‡nextå®ç°ç”Ÿæˆå™¨æ‰§è¡Œæµæ›´ç»†ç²’çš„è°ƒåº¦å—?
è¿™é‡ŒæŠŠç¢°åˆ°yieldä¹‹å‰çš„ä»£ç ä½œä¸º<code>__enter__</code>éƒ¨åˆ†,
æŠŠåé¢æ‰§è¡Œè§¦å‘StopIterationé”™è¯¯çš„ä»£ç ä½œä¸º<code>__exit__</code>éƒ¨åˆ†å®ç°ä¸Šä¸‹æ–‡ç®¡ç†å™¨çš„é€€å‡º.<br/>
ç°åœ¨çŸ¥é“ä¸ºä»€ä¹ˆè¦æŠŠä¸€ä¸ªå‡½æ•°æ‰§è¡Œæµå¼„çš„å››åˆ†äº”è£‚äº†å§ ğŸ˜„
 <br/></p>
<h2>ä»Šå¤©å…ˆå†™è¿™ä¹ˆå¤š, æ˜å¤©ç»§ç»­!</h2>
<h3>ç”Ÿæˆå™¨ç”¨äºå¼‚æ­¥è°ƒåº¦</h3>
<h3>åç¨‹: å•çº¿ç¨‹å¹¶å‘</h3>
        <div id="disqus_thread"></div>
        <script>
        /**
        * RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
        * LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables
        */
        /*
        var disqus_config = function () {
        this.page.url = PAGE_URL; // Replace PAGE_URL with your page's canonical URL variable
        this.page.identifier = PAGE_IDENTIFIER; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
        };
        */
        (function() { // DON'T EDIT BELOW THIS LINE
        var d = document, s = d.createElement('script');

        s.src = '//neo1218flask.disqus.com/embed.js';

        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
        })();
        </script>
        <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>
    </body>
</html>
